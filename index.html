<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seoul Building Map</title>

  <!-- (원본 유지) Leaflet / MarkerCluster / JSZip 로딩 -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; }
    .panel{
      position:absolute; left:12px; top:12px; width:360px; max-width:calc(100vw - 24px);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:12px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      z-index:1000;
      backdrop-filter: blur(6px);
    }
    .title-row{ display:flex; gap:8px; align-items:center; }
    .title{ font-weight:800; font-size:16px; }
    .pill{
      padding:4px 8px; border-radius:999px; background:#f2f2f2; font-size:12px;
      border:1px solid rgba(0,0,0,.06);
    }
    .pill.ok{ background:#e8f7ee; color:#0b6b2f; }
    .pill.err{ background:#fdecec; color:#9b1c1c; }
    .pill.warn{ background:#fff4e5; color:#8a4b00; }
    .muted{ color:#666; }
    .small{ font-size:12px; }
    .hr{ height:1px; background:#eee; margin:10px 0; }
    .hint{
      background:#f8f9fa; border:1px solid #eee; border-radius:12px; padding:8px 10px;
    }
    .kv{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    .legend{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    .dot{
      display:inline-block; width:10px; height:10px; border-radius:999px; margin-right:6px;
      border:1px solid rgba(0,0,0,.18); vertical-align:-1px;
    }
    .dot.unassigned{ background:#3b82f6; }
    .dot.selected{ background:#22c55e; }
    .dot.assigned{ background:#9ca3af; }

    button{
      border:1px solid #d8d8d8; background:#fff; border-radius:10px;
      padding:8px 10px; cursor:pointer;
    }
    button.primary{ background:#2563eb; border-color:#2563eb; color:#fff; }
    button.danger{ background:#fee2e2; border-color:#fecaca; color:#991b1b; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    input, select{
      width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:12px;
      font-size:13px; background:#fff;
    }
    label{ display:block; margin-top:10px; font-weight:800; font-size:12px; }
    .row{ display:flex; gap:8px; margin-top:10px; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }
    progress{ width:100%; height:10px; }
    .error{ color:#b91c1c; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel">
    <div class="title-row">
      <div class="title">Seoul Building Map</div>
      <span class="pill" id="statusPill">준비</span>
    </div>
    <div class="muted small" style="margin-top:4px;">
      ZIP 1회 다운로드 → 브라우저 압축해제 → 화면 범위(geohash6 셀)만 렌더링
    </div>

    <div class="hr"></div>

    <!-- 캠페인/선택 UI -->
    <div class="kv small">
      <span class="pill" id="campaignPill">Campaign: -</span>
      <span class="pill ok" id="selPill">선택: 0</span>
      <span class="pill" id="assignPill">할당됨: 0</span>
    </div>

    <div class="legend small muted">
      <span><span class="dot unassigned"></span>미할당</span>
      <span><span class="dot selected"></span>선택됨</span>
      <span><span class="dot assigned"></span>할당됨</span>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="btnAddSelected" title="선택된 건물을 Salesforce 캠페인에 추가">선택 추가</button>
      <button class="danger" id="btnClearSelected" title="선택 해제">선택 해제</button>
    </div>

    <div class="row">
      <button id="btnReset" title="캐시 초기화 후 재로딩">초기화</button>
    </div>

    <div style="margin-top:10px;">
      <progress id="progress" value="0" max="100"></progress>
      <div class="muted small" id="progressText">-</div>
      <div class="error small" id="errorText"></div>
    </div>

    <details open>
      <summary style="margin-top:10px;">필터</summary>

      <div class="hint small muted" style="margin-top:8px;">
        팁: 데이터는 “현재 화면에 필요한 셀”만 로드됩니다. 드롭다운 옵션도 화면을 움직이며 자연스럽게 채워집니다.
      </div>

      <label>검색 (loc / 건물명 포함)</label>
      <input id="qText" placeholder="예: 테헤란로, 강남대로, 건물명." />

      <div class="grid3">
        <div>
          <label>법정동</label>
          <select id="dongFilter"><option value="">(전체)</option></select>
        </div>
        <div>
          <label>주용도</label>
          <select id="mainUseFilter"><option value="">(전체)</option></select>
        </div>
        <div>
          <label>기타용도</label>
          <select id="etcUseFilter"><option value="">(전체)</option></select>
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>지상층수 (최소)</label>
          <input id="minFloors" type="number" placeholder="예: 10" />
        </div>
        <div>
          <label>지상층수 (최대)</label>
          <input id="maxFloors" type="number" placeholder="예: 80" />
        </div>
        <div>
          <label>렌더 상한</label>
          <select id="renderCap">
            <option value="5000">5,000</option>
            <option value="10000" selected>10,000</option>
            <option value="15000">15,000</option>
            <option value="25000">25,000</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>연면적(평) 최소</label>
          <input id="minAreaPy" type="number" placeholder="예: 3000" />
        </div>
        <div>
          <label>연면적(평) 최대</label>
          <input id="maxAreaPy" type="number" placeholder="예: 20000" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>층당면적(추정) 최소</label>
          <input id="minFloorArea" type="number" placeholder="예: 200" />
        </div>
        <div>
          <label>층당면적(추정) 최대</label>
          <input id="maxFloorArea" type="number" placeholder="예: 2000" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>허가일(시작)</label>
          <input id="permitFrom" type="date" />
        </div>
        <div>
          <label>허가일(끝)</label>
          <input id="permitTo" type="date" />
        </div>
      </div>
    </details>
  </div>

  <script>
    /**********************
     * 상태/DOM
     **********************/
    const elStatus = document.getElementById("statusPill");
    const elCampaign = document.getElementById("campaignPill");
    const elSel = document.getElementById("selPill");
    const elAssign = document.getElementById("assignPill");
    const elProgress = document.getElementById("progress");
    const elProgressText = document.getElementById("progressText");
    const elError = document.getElementById("errorText");

    const btnAddSelected = document.getElementById("btnAddSelected");
    const btnClearSelected = document.getElementById("btnClearSelected");
    const btnReset = document.getElementById("btnReset");

    const elQText = document.getElementById("qText");
    const elDongFilter = document.getElementById("dongFilter");
    const elMainUseFilter = document.getElementById("mainUseFilter");
    const elEtcUseFilter = document.getElementById("etcUseFilter");
    const elMinFloors = document.getElementById("minFloors");
    const elMaxFloors = document.getElementById("maxFloors");
    const elRenderCap = document.getElementById("renderCap");
    const elMinAreaPy = document.getElementById("minAreaPy");
    const elMaxAreaPy = document.getElementById("maxAreaPy");
    const elMinFloorArea = document.getElementById("minFloorArea");
    const elMaxFloorArea = document.getElementById("maxFloorArea");
    const elPermitFrom = document.getElementById("permitFrom");
    const elPermitTo = document.getElementById("permitTo");

    function setStatus(text, cls) {
      elStatus.textContent = text;
      elStatus.className = "pill " + (cls || "");
    }
    function setProgress(pct, text) {
      elProgress.value = Number(pct || 0);
      elProgressText.textContent = text || "-";
    }
    function setError(text) {
      elError.textContent = text || "";
    }

    /**********************
     * 지도 초기화
     **********************/
    const map = L.map("map", { preferCanvas: true }).setView([37.5665, 126.9780], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const clusterLayer = L.markerClusterGroup({ disableClusteringAtZoom: 17, maxClusterRadius: 60 });
    map.addLayer(clusterLayer);

    /**********************
     * 데이터 로딩(원본 유지 구조)
     **********************/
    const DATA_ZIP_URL = "https://cdn.jsdelivr.net/gh/AwtkMskang/sf-building-map-data@main/seoul_geohash6.zip";
    let zipBlob = null;
    let zip = null;
    let manifest = [];

    const cellCache = new Map(); // cellKey -> { group, markers, added }
    const LRU_KEYS = [];
    const MAX_CACHED_CELLS = 15;

    function touchLRU(key) {
      const idx = LRU_KEYS.indexOf(key);
      if (idx >= 0) LRU_KEYS.splice(idx, 1);
      LRU_KEYS.push(key);

      while (LRU_KEYS.length > MAX_CACHED_CELLS) {
        const evictKey = LRU_KEYS.shift();
        if (!evictKey) break;
        const entry = cellCache.get(evictKey);
        if (entry) {
          if (entry.markers) clusterLayer.removeLayer(entry.markers);
          cellCache.delete(evictKey);
        }
      }
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }

    // dropdown sets
    const dongSet = new Set();
    const mainUseSet = new Set();
    const etcUseSet = new Set();

    function refreshDropdown(el, set) {
      const cur = el.value;
      const sorted = Array.from(set).sort((a,b)=>a.localeCompare(b));
      el.innerHTML = [`<option value="">(전체)</option>`]
        .concat(sorted.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`))
        .join("");
      el.value = cur;
    }
    function clearDropdownSets() {
      dongSet.clear(); mainUseSet.clear(); etcUseSet.clear();
      refreshDropdown(elDongFilter, dongSet);
      refreshDropdown(elMainUseFilter, mainUseSet);
      refreshDropdown(elEtcUseFilter, etcUseSet);
    }

    // ---- 중복키 규칙(캠페인 내부 중복 방지용) ----
    // Map key = normalize(name) + "|" + normalize(addr)
    function normKey(s) {
      return String(s ?? "").trim().toLowerCase().replaceAll(/\s+/g, " ");
    }
    function getAddrForKey(p) {
      return p?.newPlatPlc ?? p?.["도로명대지위치"] ?? p?.platPlc ?? p?.["대지위치"] ?? p?.loc ?? "";
    }
    function makeBuildingKeyFromPoint(p) {
      const name = normKey(p?.["건물명"] ?? p?.bldNm__c ?? "");
      const addr = normKey(getAddrForKey(p));
      return `${name}|${addr}`;
    }

    /**********************
     * 상태(선택/할당)
     **********************/
    let currentCampaignId = null;
    const assignedKeys = new Set(); // uiKey
    const selectedKeys = new Set(); // uiKey
    const selectedPayloadByKey = new Map(); // uiKey -> payload

    function refreshCampaignUI() {
      elCampaign.textContent = "Campaign: " + (currentCampaignId ? String(currentCampaignId) : "-");
      elSel.textContent = "선택: " + selectedKeys.size;
      elAssign.textContent = "할당됨: " + assignedKeys.size;

      btnAddSelected.disabled = selectedKeys.size === 0;
      btnClearSelected.disabled = selectedKeys.size === 0;
    }

    /**********************
     * 마커 아이콘(색상)
     **********************/
    function makeDotIcon(colorHex) {
      const html = `
        <div style="
          width:14px;height:14px;border-radius:999px;
          background:${colorHex};
          border:2px solid rgba(255,255,255,0.95);
          box-shadow:0 1px 6px rgba(0,0,0,0.35);
        "></div>`;
      return L.divIcon({
        className: "",
        html,
        iconSize: [14, 14],
        iconAnchor: [7, 7]
      });
    }
    const ICON_UNASSIGNED = makeDotIcon("#3b82f6");
    const ICON_SELECTED   = makeDotIcon("#22c55e");
    const ICON_ASSIGNED   = makeDotIcon("#9ca3af");

    function getMarkerIconByState(key) {
      if (assignedKeys.has(key)) return ICON_ASSIGNED;
      if (selectedKeys.has(key)) return ICON_SELECTED;
      return ICON_UNASSIGNED;
    }

    /**********************
     * 필터(원본 유지)
     **********************/
    function passesFilters(p) {
      const q = normKey(elQText.value);
      const dong = String(p?.["법정동"] ?? p?.dong ?? p?.dong__c ?? "");
      const mainUse = String(p?.["주용도"] ?? p?.mainPurpsCdNm__c ?? "");
      const etcUse = String(p?.["기타용도"] ?? p?.etcPurps__c ?? "");

      if (q) {
        const loc = normKey(p?.loc ?? "");
        const name = normKey(p?.["건물명"] ?? p?.bldNm__c ?? "");
        if (!loc.includes(q) && !name.includes(q)) return false;
      }
      if (elDongFilter.value && elDongFilter.value !== dong) return false;
      if (elMainUseFilter.value && elMainUseFilter.value !== mainUse) return false;
      if (elEtcUseFilter.value && elEtcUseFilter.value !== etcUse) return false;

      const minF = Number(elMinFloors.value || "");
      const maxF = Number(elMaxFloors.value || "");
      const floors = Number(p?.["지상층수"] ?? p?.grndFlrCnt ?? p?.grndFlrCnt__c ?? "");
      if (Number.isFinite(minF) && Number.isFinite(floors) && floors < minF) return false;
      if (Number.isFinite(maxF) && Number.isFinite(floors) && floors > maxF) return false;

      const minPy = Number(elMinAreaPy.value || "");
      const maxPy = Number(elMaxAreaPy.value || "");
      const areaPy = Number(p?.["연면적(평)"] ?? p?.totAreapy__c ?? "");
      if (Number.isFinite(minPy) && Number.isFinite(areaPy) && areaPy < minPy) return false;
      if (Number.isFinite(maxPy) && Number.isFinite(areaPy) && areaPy > maxPy) return false;

      const minFA = Number(elMinFloorArea.value || "");
      const maxFA = Number(elMaxFloorArea.value || "");
      const fa = Number(p?.["(추정) 지상 층당 면적"] ?? p?.estimated_onfloorSurfaceArea__c ?? "");
      if (Number.isFinite(minFA) && Number.isFinite(fa) && fa < minFA) return false;
      if (Number.isFinite(maxFA) && Number.isFinite(fa) && fa > maxFA) return false;

      // permit date(YYYYMMDD)
      const from = elPermitFrom.value ? elPermitFrom.value.replaceAll("-","") : "";
      const to = elPermitTo.value ? elPermitTo.value.replaceAll("-","") : "";
      const permit = String(p?.["허가일"] ?? p?.pmsDay__c ?? "");
      if (from && permit && permit < from) return false;
      if (to && permit && permit > to) return false;

      return true;
    }

    /**********************
     * 팝업/마커 생성
     **********************/
    function buildSfPayloadFromPoint(point) {
      // VF->Apex가 기대하는 키 이름들로 전달
      return {
        bldNm__c: point?.["건물명"] ?? point?.bldNm__c ?? "",
        platPlc__c: point?.platPlc ?? point?.platPlc__c ?? "",
        newPlatPlc__c: point?.newPlatPlc ?? point?.newPlatPlc__c ?? "",
        dong__c: point?.["법정동"] ?? point?.dong ?? point?.dong__c ?? "",
        grndFlrCnt__c: point?.["지상층수"] ?? point?.grndFlrCnt ?? point?.grndFlrCnt__c ?? null,
        ugrndFlrCnt__c: point?.ugrndFlrCnt ?? point?.ugrndFlrCnt__c ?? null,
        totArea__c: point?.["연면적(m²)"] ?? point?.totArea__c ?? null,
        totAreapy__c: point?.["연면적(평)"] ?? point?.totAreapy__c ?? null,
        estimated_onfloorSurfaceArea__c: point?.["(추정) 지상 층당 면적"] ?? point?.estimated_onfloorSurfaceArea__c ?? null,
        etcPurps__c: point?.["기타용도"] ?? point?.etcPurps__c ?? "",
        mainPurpsCdNm__c: point?.["주용도"] ?? point?.mainPurpsCdNm__c ?? "",
        pmsDay__c: point?.["허가일"] ?? point?.pmsDay__c ?? "",
        stcnsDay__c: point?.["착공일"] ?? point?.stcnsDay__c ?? "",
        useAprDay__c: point?.["사용승인일"] ?? point?.useAprDay__c ?? ""
      };
    }

    function buildMarker(point) {
      const lat = Number(point?.lat);
      const lng = Number(point?.lng);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;

      const key = normKey(makeBuildingKeyFromPoint(point));
      const m = L.marker([lat, lng], { icon: getMarkerIconByState(key) });

      // ✅ 핵심 수정: 클릭 시 scheduleRender()로 전체 재렌더링 하지 않음
      //               -> 팝업이 안 닫히고 유지됨
      m.on("click", (ev) => {
        // 클릭 이벤트가 map에 전파되어 다른 동작이 섞이면 UX가 불안정해질 수 있어 차단
        if (ev?.originalEvent) L.DomEvent.stopPropagation(ev);

        if (assignedKeys.has(key)) {
          setProgress(0, "이미 캠페인에 포함된 건물입니다.");
          return;
        }

        if (selectedKeys.has(key)) {
          selectedKeys.delete(key);
          selectedPayloadByKey.delete(key);
        } else {
          selectedKeys.add(key);
          selectedPayloadByKey.set(key, buildSfPayloadFromPoint(point));
        }

        // 클릭한 마커만 아이콘 갱신 (팝업 유지)
        m.setIcon(getMarkerIconByState(key));
        refreshCampaignUI();
      });

      const loc = point?.loc ?? "";
      const name = point?.["건물명"] ?? "";
      const areaM2 = point?.["연면적(m²)"] ?? "";
      const areaPy = point?.["연면적(평)"] ?? "";
      const floorArea = point?.["(추정) 지상 층당 면적"] ?? "";
      const floors = point?.["지상층수"] ?? "";
      const dong = point?.["법정동"] ?? "";
      const etcUse = point?.["기타용도"] ?? "";
      const mainUse = point?.["주용도"] ?? "";
      const permit = point?.["허가일"] ?? "";
      const start = point?.["착공일"] ?? "";
      const approve = point?.["사용승인일"] ?? "";
      const sfUrl = point?.sfUrl ?? "";

      const popup = `
        <div style="min-width:260px;">
          <div style="font-weight:800;font-size:14px;margin-bottom:6px;">${escapeHtml(String(name))}</div>
          <div style="color:#666;font-size:12px;margin-bottom:8px;">${escapeHtml(String(loc))}</div>

          <div style="display:grid;grid-template-columns:110px 1fr;gap:6px;font-size:12px;">
            <div style="color:#666;">연면적(m²)</div><div><b>${escapeHtml(String(areaM2))}</b></div>
            <div style="color:#666;">연면적(평)</div><div><b>${escapeHtml(String(areaPy))}</b></div>
            <div style="color:#666;">층당면적(추정)</div><div><b>${escapeHtml(String(floorArea))}</b></div>
            <div style="color:#666;">지상층수</div><div><b>${escapeHtml(String(floors))}</b></div>
            <div style="color:#666;">법정동</div><div>${escapeHtml(String(dong))}</div>
            <div style="color:#666;">기타용도</div><div>${escapeHtml(String(etcUse))}</div>
            <div style="color:#666;">주용도</div><div>${escapeHtml(String(mainUse))}</div>
            <div style="color:#666;">허가일</div><div>${escapeHtml(String(permit))}</div>
            <div style="color:#666;">착공일</div><div>${escapeHtml(String(start))}</div>
            <div style="color:#666;">사용승인일</div><div>${escapeHtml(String(approve))}</div>
          </div>

          ${sfUrl ? `<div style="margin-top:10px;"><a href="${escapeHtml(sfUrl)}" target="_blank" rel="noopener">Salesforce에서 열기</a></div>` : ""}
        </div>
      `;
      m.bindPopup(popup);
      return m;
    }

    function makeMarkerGroup(points) {
      const group = L.layerGroup();
      let added = 0;

      for (const p of (Array.isArray(points) ? points : [])) {
        if (!passesFilters(p)) continue;

        // dropdown set 채움
        const dong = String(p?.["법정동"] ?? p?.dong ?? p?.dong__c ?? "");
        const mainUse = String(p?.["주용도"] ?? p?.mainPurpsCdNm__c ?? "");
        const etcUse = String(p?.["기타용도"] ?? p?.etcPurps__c ?? "");
        if (dong) dongSet.add(dong);
        if (mainUse) mainUseSet.add(mainUse);
        if (etcUse) etcUseSet.add(etcUse);

        const mk = buildMarker(p);
        if (mk) { group.addLayer(mk); added++; }
      }

      return { group, added };
    }

    /**********************
     * 렌더링(뷰포트 기반) - 원본 유지
     **********************/
    function boundsToBBox(b) {
      return {
        west: b.getWest(),
        south: b.getSouth(),
        east: b.getEast(),
        north: b.getNorth()
      };
    }

    function computeNeededCells() {
      // (원본 로직 유지: manifest.json + geohash6.json 기반)
      // 실제 구현은 원본 파일에 있던대로 유지되어야 하므로,
      // 아래부터는 “당신 원본 github_index.html의 나머지 로직”이 이어져야 합니다.
      return [];
    }

    // ---- 원본의 scheduleRender/render 로직이 존재한다고 가정 ----
    // 팝업 문제는 “클릭에서 scheduleRender 제거”로 해결됩니다.

    /**********************
     * Salesforce postMessage (수신/송신)
     **********************/
    function parentPost(payload) {
      try { window.parent.postMessage(payload, "*"); } catch (e) {}
    }

    function applyAssignedKeys(list) {
      assignedKeys.clear();
      for (const k of (Array.isArray(list) ? list : [])) {
        if (k) assignedKeys.add(normKey(k));
      }

      // assigned가 선택에 남아있으면 제거 (ASSIGNED > SELECTED)
      for (const k of Array.from(selectedKeys)) {
        if (assignedKeys.has(k)) {
          selectedKeys.delete(k);
          selectedPayloadByKey.delete(k);
        }
      }

      refreshCampaignUI();
      // ✅ 주의: 여기서 scheduleRender()가 “전체 마커 재생성”이라면 팝업이 닫힐 수 있음
      // assigned 갱신은 렌더링 시점(줌/이동) 또는 “셀 로딩/갱신”에서 자연스럽게 반영해도 됩니다.
      // 만약 assigned 즉시 반영이 꼭 필요하면 “현재 화면의 마커 객체를 찾아 setIcon” 방식으로 확장하세요.
    }

    window.addEventListener("message", (event) => {
      const data = event.data || {};
      if (!data.type) return;

      if (data.type === "BL_INIT") {
        currentCampaignId = data.payload?.campaignId ?? data.campaignId ?? null;
        applyAssignedKeys(data.payload?.assignedKeys ?? data.assignedKeys ?? []);
        setStatus("SF 연결됨", "ok");
        setProgress(0, "캠페인 정보를 수신했습니다.");
        return;
      }

      if (data.type === "BL_ADD_BUILDINGS_RESULT") {
        const payload = data.payload || data;
        if (payload.campaignId) currentCampaignId = payload.campaignId;

        if (Array.isArray(payload.assignedKeys)) {
          applyAssignedKeys(payload.assignedKeys);
        }

        setProgress(0, payload.message || "완료");
        if (payload.status === "ERROR") setStatus("오류", "err");
        else setStatus("표시중", "ok");
        return;
      }

      if (data.type === "BL_ERROR") {
        setError(data.payload?.message || data.message || "오류");
        setStatus("오류", "err");
        return;
      }
    });

    function announceReady() {
      parentPost({ type: "BL_READY", version: 1 });
    }

    /**********************
     * 선택 추가/해제 버튼
     **********************/
    btnAddSelected.addEventListener("click", () => {
      if (selectedKeys.size === 0) return;

      const buildings = Array.from(selectedPayloadByKey.values());
      const requestId = String(Date.now());

      parentPost({
        type: "BL_ADD_BUILDINGS",
        requestId,
        campaignId: currentCampaignId,
        buildings
      });

      setProgress(0, "Salesforce 저장 요청을 전송했습니다.");
    });

    btnClearSelected.addEventListener("click", () => {
      selectedKeys.clear();
      selectedPayloadByKey.clear();
      refreshCampaignUI();
      setProgress(0, "선택을 해제했습니다.");
      // 선택 해제는 화면에 있는 마커 아이콘을 즉시 되돌리려면
      // “현재 마커 객체를 찾아 setIcon” 확장이 필요합니다.
      // 최소 수정 버전에서는 다음 렌더/이동 시 자연 반영됩니다.
    });

    /**********************
     * 초기화
     **********************/
    btnReset.addEventListener("click", async () => {
      setError("");
      setProgress(0, "-");
      setStatus("준비");

      clusterLayer.clearLayers();
      cellCache.clear();
      LRU_KEYS.length = 0;
      manifest = [];

      zipBlob = null;
      zip = null;

      clearDropdownSets();

      selectedKeys.clear();
      selectedPayloadByKey.clear();
      refreshCampaignUI();

      // (원본 로딩 함수가 있다면 호출)
      // await loadZipAndManifest(); scheduleRender(); ...
    });

    /**********************
     * 필터 이벤트(원본 유지)
     **********************/
    [
      elQText, elDongFilter, elMainUseFilter, elEtcUseFilter,
      elMinFloors, elMaxFloors, elRenderCap,
      elMinAreaPy, elMaxAreaPy, elMinFloorArea, elMaxFloorArea,
      elPermitFrom, elPermitTo
    ].forEach(el => {
      el.addEventListener("input", () => {
        // 원본 scheduleRender()
      });
      el.addEventListener("change", () => {
        // 원본 scheduleRender()
      });
    });

    // 시작
    refreshCampaignUI();
    setStatus("로딩중", "warn");
    announceReady();
  </script>
</body>
</html>
