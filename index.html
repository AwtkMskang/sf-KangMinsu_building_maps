<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Seoul Building Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; }

    .panel{
      position:absolute; left:12px; top:12px; width:420px; max-width:calc(100vw - 24px);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:12px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      z-index:1000;
      backdrop-filter: blur(6px);
    }
    .title-row{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .title{ font-weight:800; font-size:16px; }
    .pill{
      padding:4px 8px; border-radius:999px; background:#f2f2f2; font-size:12px;
      border:1px solid rgba(0,0,0,.06);
      display:inline-block;
      margin-right:6px;
      margin-top:6px;
    }
    .pill.ok{ background:#e8f7ee; color:#0b6b2f; }
    .pill.err{ background:#fdecec; color:#9b1c1c; }
    .pill.warn{ background:#fff4e5; color:#8a4b00; }
    .muted{ color:#666; }
    .small{ font-size:12px; }
    .hr{ height:1px; background:#eee; margin:10px 0; }

    button{
      border:1px solid #d8d8d8; background:#fff; border-radius:10px;
      padding:8px 10px; cursor:pointer;
    }
    button.primary{ background:#2563eb; border-color:#2563eb; color:#fff; }
    button.danger{ background:#fee2e2; border-color:#fecaca; color:#991b1b; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    progress{ width:100%; height:10px; }
    .error{ color:#b91c1c; }

    details { border:1px solid rgba(0,0,0,.06); border-radius:12px; padding:8px 10px; background:#fff; }
    details summary { cursor:pointer; font-weight:700; font-size:12px; }
    .filters { margin-top:8px; display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .frow { display:flex; flex-direction:column; gap:4px; }
    .frow label { font-size:11px; color:#444; font-weight:700; }
    .frow input {
      border:1px solid #e5e5e5; border-radius:10px; padding:8px 10px; font-size:12px;
      outline:none;
    }
    .filters .span2 { grid-column: span 2; }

    .popupTable { width:100%; border-collapse:collapse; font-size:12px; }
    .popupTable td { border-top:1px solid #eee; padding:6px 4px; vertical-align:top; }
    .popupTable td.k { width:40%; color:#555; font-weight:700; }
    .popupTable td.v { width:60%; color:#111; }
    .popupTitle { font-weight:800; font-size:13px; margin-bottom:6px; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel">
    <div class="title-row">
      <div class="title">Seoul Building Map</div>
      <span class="pill" id="statusPill">준비</span>
    </div>

    <div class="muted small" style="margin-top:4px;">
      ZIP 1회 다운로드 → 화면 범위(geohash6 셀)만 렌더링 (bounds + 필터 동시 적용)
    </div>

    <div class="hr"></div>

    <div class="small">
      <span class="pill" id="campaignPill">Campaign: -</span>
      <span class="pill ok" id="selPill">선택: 0</span>
      <span class="pill" id="assignPill">할당됨: 0</span>
      <span class="pill" id="markerPill">화면 마커: 0</span>
    </div>

    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="primary" id="btnAddSelected">선택 추가</button>
      <button class="danger" id="btnClearSelected">선택 해제</button>
    </div>

    <div style="margin-top:10px;">
      <details open>
        <summary>필터</summary>
        <div class="filters" id="filters">
          <!-- 텍스트 -->
          <div class="frow span2">
            <label>loc (주소) 포함</label>
            <input id="f_loc" placeholder="예: 송파구 잠실동" />
          </div>
          <div class="frow span2">
            <label>건물명 포함</label>
            <input id="f_name" placeholder="예: 교육지원청" />
          </div>

          <!-- 숫자 -->
          <div class="frow">
            <label>연면적(m²) 최소</label>
            <input id="f_totAreaMin" placeholder="예: 1000" />
          </div>
          <div class="frow">
            <label>연면적(m²) 최대</label>
            <input id="f_totAreaMax" placeholder="예: 50000" />
          </div>

          <div class="frow">
            <label>연면적(평) 최소</label>
            <input id="f_totPyMin" placeholder="예: 300" />
          </div>
          <div class="frow">
            <label>연면적(평) 최대</label>
            <input id="f_totPyMax" placeholder="예: 15000" />
          </div>

          <div class="frow">
            <label>(추정) 지상 층당 면적 최소</label>
            <input id="f_onfloorMin" placeholder="예: 50" />
          </div>
          <div class="frow">
            <label>(추정) 지상 층당 면적 최대</label>
            <input id="f_onfloorMax" placeholder="예: 1000" />
          </div>

          <div class="frow">
            <label>지상층수 최소</label>
            <input id="f_flrMin" placeholder="예: 3" />
          </div>
          <div class="frow">
            <label>지상층수 최대</label>
            <input id="f_flrMax" placeholder="예: 80" />
          </div>

          <!-- 텍스트 -->
          <div class="frow">
            <label>법정동 포함</label>
            <input id="f_dong" placeholder="예: 잠실동" />
          </div>
          <div class="frow">
            <label>기타용도 포함</label>
            <input id="f_etcPurps" placeholder="예: 업무시설" />
          </div>

          <div class="frow">
            <label>주용도 포함</label>
            <input id="f_mainPurps" placeholder="예: 업무시설" />
          </div>
          <div class="frow">
            <label>대장구분코드명 포함</label>
            <input id="f_ledgGbn" placeholder="예: 일반" />
          </div>

          <div class="frow">
            <label>대장종류코드명 포함</label>
            <input id="f_ledgKind" placeholder="예: 일반건축물" />
          </div>
          <div class="frow">
            <label> </label>
            <input disabled value=" " />
          </div>

          <!-- 날짜 -->
          <div class="frow">
            <label>허가일 From (YYYYMMDD)</label>
            <input id="f_pmsFrom" placeholder="예: 19800101" />
          </div>
          <div class="frow">
            <label>허가일 To (YYYYMMDD)</label>
            <input id="f_pmsTo" placeholder="예: 20261231" />
          </div>

          <div class="frow">
            <label>착공일 From (YYYYMMDD)</label>
            <input id="f_stcFrom" placeholder="예: 19800101" />
          </div>
          <div class="frow">
            <label>착공일 To (YYYYMMDD)</label>
            <input id="f_stcTo" placeholder="예: 20261231" />
          </div>

          <div class="frow">
            <label>사용승인일 From (YYYYMMDD)</label>
            <input id="f_useFrom" placeholder="예: 19800101" />
          </div>
          <div class="frow">
            <label>사용승인일 To (YYYYMMDD)</label>
            <input id="f_useTo" placeholder="예: 20261231" />
          </div>

          <div class="frow span2">
            <button id="btnResetFilters" type="button">필터 초기화</button>
          </div>
        </div>
      </details>
    </div>

    <div style="margin-top:10px;">
      <progress id="progress" value="0" max="100"></progress>
      <div class="muted small" id="progressText">-</div>
      <div class="error small" id="errorText"></div>
    </div>
  </div>

  <script>
    /**********************
     * 설정
     **********************/
    const DEBUG_BRIDGE = true;

    // ✅ 데이터 ZIP
    const DATA_ZIP_URL = "https://cdn.jsdelivr.net/gh/AwtkMskang/sf-building-map-data@main/seoul_geohash6.zip";

    // 너무 무거우면 화면에 올릴 최대 마커 수를 제한
    const MAX_MARKERS_ON_SCREEN = 20000;

    // ✅ 타임아웃 정책 (모달 입력시간 고려)
    const ACK_TIMEOUT_MS = 10 * 1000;          // 10초 안에 ACK가 와야 브릿지 정상
    const RESULT_TIMEOUT_MS = 10 * 60 * 1000;  // 10분(캠페인 생성 모달 입력 시간 포함)

    /**********************
     * DOM helpers
     **********************/
    const elStatus = document.getElementById("statusPill");
    const elCampaign = document.getElementById("campaignPill");
    const elSel = document.getElementById("selPill");
    const elAssign = document.getElementById("assignPill");
    const elMarker = document.getElementById("markerPill");
    const elProgress = document.getElementById("progress");
    const elProgressText = document.getElementById("progressText");
    const elError = document.getElementById("errorText");
    const btnAddSelected = document.getElementById("btnAddSelected");
    const btnClearSelected = document.getElementById("btnClearSelected");
    const btnResetFilters = document.getElementById("btnResetFilters");

    function setStatus(text, cls) {
      elStatus.textContent = text;
      elStatus.className = "pill " + (cls || "");
    }
    function setProgress(pct, text) {
      elProgress.value = Number(pct || 0);
      elProgressText.textContent = text || "-";
    }
    function setError(text) {
      elError.textContent = text || "";
    }

    /**********************
     * Bridge state
     **********************/
    let parentOrigin = "*";
    let bridgeToken = null;
    let vfReady = false;

    function postToParent(msg) {
      window.parent.postMessage(msg, parentOrigin || "*");
      if (DEBUG_BRIDGE) console.log("Map -> VF send", { targetOrigin: parentOrigin || "*", msg });
    }

    /**********************
     * Map init
     **********************/
    const map = L.map("map", { preferCanvas: true }).setView([37.5665, 126.9780], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const clusterLayer = L.markerClusterGroup({
      disableClusteringAtZoom: 17,
      maxClusterRadius: 60
    });
    map.addLayer(clusterLayer);

    /**********************
     * 선택/할당
     * ✅ key = BuildingLibrary Id
     **********************/
    let currentCampaignId = null;

    const assignedKeys = new Set(); // buildingLibraryId
    const selectedKeys = new Set(); // buildingLibraryId
    const selectedPayloadByKey = new Map(); // id -> payload for SF

    function refreshUI(screenCount = null) {
      elCampaign.textContent = "Campaign: " + (currentCampaignId ? String(currentCampaignId) : "-");
      elSel.textContent = "선택: " + selectedKeys.size;
      elAssign.textContent = "할당됨: " + assignedKeys.size;
      if (screenCount !== null) elMarker.textContent = "화면 마커: " + screenCount;

      btnAddSelected.disabled = selectedKeys.size === 0;
      btnClearSelected.disabled = selectedKeys.size === 0;
    }

    function normText(s) {
      return String(s ?? "").trim().toLowerCase().replace(/\s+/g, " ");
    }

    function getIdForKey(p) {
      return String(p?.Id ?? p?.id ?? "").trim();
    }

    /**********************
     * 필터 상태
     **********************/
    const filterEls = {
      loc: document.getElementById("f_loc"),
      name: document.getElementById("f_name"),
      totAreaMin: document.getElementById("f_totAreaMin"),
      totAreaMax: document.getElementById("f_totAreaMax"),
      totPyMin: document.getElementById("f_totPyMin"),
      totPyMax: document.getElementById("f_totPyMax"),
      onfloorMin: document.getElementById("f_onfloorMin"),
      onfloorMax: document.getElementById("f_onfloorMax"),
      flrMin: document.getElementById("f_flrMin"),
      flrMax: document.getElementById("f_flrMax"),
      dong: document.getElementById("f_dong"),
      etcPurps: document.getElementById("f_etcPurps"),
      mainPurps: document.getElementById("f_mainPurps"),
      ledgGbn: document.getElementById("f_ledgGbn"),
      ledgKind: document.getElementById("f_ledgKind"),
      pmsFrom: document.getElementById("f_pmsFrom"),
      pmsTo: document.getElementById("f_pmsTo"),
      stcFrom: document.getElementById("f_stcFrom"),
      stcTo: document.getElementById("f_stcTo"),
      useFrom: document.getElementById("f_useFrom"),
      useTo: document.getElementById("f_useTo"),
    };

    function parseNum(v) {
      const s = String(v ?? "").trim().replace(/,/g, "");
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function parseYMD(v) {
      const s = String(v ?? "").trim();
      if (!s) return null;
      // supports YYYYMMDD or YYYY-MM-DD
      let y, m, d;
      if (/^\d{8}$/.test(s)) {
        y = Number(s.slice(0,4));
        m = Number(s.slice(4,6));
        d = Number(s.slice(6,8));
      } else if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
        const p = s.split("-");
        y = Number(p[0]); m = Number(p[1]); d = Number(p[2]);
      } else {
        return null;
      }
      if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return null;
      // UTC 기준으로 비교(시간 영향 제거)
      return Date.UTC(y, m-1, d);
    }

    function textContains(hay, needle) {
      const n = normText(needle);
      if (!n) return true;
      return normText(hay).includes(n);
    }

    function numInRange(v, minStr, maxStr) {
      const n = parseNum(v);
      const min = parseNum(minStr);
      const max = parseNum(maxStr);
      if (min !== null && (n === null || n < min)) return false;
      if (max !== null && (n === null || n > max)) return false;
      return true;
    }

    function dateInRange(v, fromStr, toStr) {
      const t = parseYMD(v);
      const from = parseYMD(fromStr);
      const to = parseYMD(toStr);
      if (from !== null && (t === null || t < from)) return false;
      if (to !== null && (t === null || t > to)) return false;
      return true;
    }

    function passesFilters(p) {
      // 텍스트
      if (!textContains(p?.loc, filterEls.loc.value)) return false;
      if (!textContains(p?.["건물명"], filterEls.name.value)) return false;
      if (!textContains(p?.["법정동"], filterEls.dong.value)) return false;
      if (!textContains(p?.["기타용도"], filterEls.etcPurps.value)) return false;
      if (!textContains(p?.["주용도"], filterEls.mainPurps.value)) return false;
      if (!textContains(p?.["대장구분코드명"], filterEls.ledgGbn.value)) return false;
      if (!textContains(p?.["대장종류코드명"], filterEls.ledgKind.value)) return false;

      // 숫자
      if (!numInRange(p?.["연면적(m²)"], filterEls.totAreaMin.value, filterEls.totAreaMax.value)) return false;
      if (!numInRange(p?.["연면적(평)"], filterEls.totPyMin.value, filterEls.totPyMax.value)) return false;
      if (!numInRange(p?.["(추정) 지상 층당 면적"], filterEls.onfloorMin.value, filterEls.onfloorMax.value)) return false;
      if (!numInRange(p?.["지상층수"], filterEls.flrMin.value, filterEls.flrMax.value)) return false;

      // 날짜
      if (!dateInRange(p?.["허가일"], filterEls.pmsFrom.value, filterEls.pmsTo.value)) return false;
      if (!dateInRange(p?.["착공일"], filterEls.stcFrom.value, filterEls.stcTo.value)) return false;
      if (!dateInRange(p?.["사용승인일"], filterEls.useFrom.value, filterEls.useTo.value)) return false;

      return true;
    }

    function wireFilterEvents() {
      Object.values(filterEls).forEach(el => {
        el.addEventListener("input", () => scheduleRender());
      });
      btnResetFilters.addEventListener("click", () => {
        Object.values(filterEls).forEach(el => el.value = "");
        scheduleRender();
      });
    }

    /**********************
     * payload (선택추가 시 SF로 보낼 값)
     **********************/
    function buildSfPayloadFromPoint(point) {
      return {
        Id: String(point?.Id ?? point?.id ?? "").trim(),
        loc: point?.loc ?? "",
        "건물명": point?.["건물명"] ?? "",
      };
    }

    /**********************
     * 마커 아이콘
     **********************/
    function makeDotIcon(colorHex) {
      const html = `<div style="
        width:14px;height:14px;border-radius:999px;
        background:${colorHex};
        border:2px solid rgba(255,255,255,0.95);
        box-shadow:0 1px 6px rgba(0,0,0,0.35);
      "></div>`;
      return L.divIcon({ className:"", html, iconSize:[14,14], iconAnchor:[7,7] });
    }
    const ICON_UNASSIGNED = makeDotIcon("#3b82f6");
    const ICON_SELECTED   = makeDotIcon("#22c55e");
    const ICON_ASSIGNED   = makeDotIcon("#9ca3af");

    function iconFor(idKey) {
      if (assignedKeys.has(idKey)) return ICON_ASSIGNED;
      if (selectedKeys.has(idKey)) return ICON_SELECTED;
      return ICON_UNASSIGNED;
    }

    /**********************
     * 데이터 로딩 (ZIP -> points[])
     **********************/
    let allPoints = [];
    let allMarkers = []; // { key(id), lat, lng, marker, point }
    let dataLoaded = false;
    let rendering = false;

    function detectLatLng(obj) {
      const lat =
        obj.lat ?? obj.latitude ?? obj.Lat ?? obj.LAT ??
        obj["위도"] ?? obj["lat"] ?? obj["LATITUDE"];
      const lng =
        obj.lng ?? obj.lon ?? obj.longitude ?? obj.Lng ?? obj.LON ??
        obj["경도"] ?? obj["lng"] ?? obj["LONGITUDE"];
      const la = Number(lat);
      const lo = Number(lng);
      if (!Number.isFinite(la) || !Number.isFinite(lo)) return null;
      return { lat: la, lng: lo };
    }

    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(Boolean);
      if (lines.length < 2) return [];
      const header = splitCSVLine(lines[0]);
      const out = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = splitCSVLine(lines[i]);
        const row = {};
        for (let j = 0; j < header.length; j++) row[header[j]] = cols[j] ?? "";
        out.push(row);
      }
      return out;
    }

    function splitCSVLine(line) {
      const out = [];
      let cur = "";
      let inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (ch === ',' && !inQ) {
          out.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(s => s.trim());
    }

    function normalizePoint(obj) {
      const ll = detectLatLng(obj);
      if (!ll) return null;
      return { ...obj, lat: ll.lat, lng: ll.lng };
    }

    async function loadZipOnce() {
      setError("");
      setStatus("로딩중", "warn");
      setProgress(2, "데이터 ZIP 다운로드 시작...");

      const resp = await fetch(DATA_ZIP_URL, { cache: "no-store" });
      if (!resp.ok) throw new Error("ZIP fetch failed: " + resp.status + " " + resp.statusText);

      const buf = await resp.arrayBuffer();
      setProgress(10, "ZIP 압축 해제 중...");

      const zip = await JSZip.loadAsync(buf);
      const files = Object.keys(zip.files).filter(n => !zip.files[n].dir);
      if (files.length === 0) throw new Error("ZIP has no files");

      let loaded = 0;
      const points = [];

      for (const fname of files) {
        const f = zip.files[fname];
        const text = await f.async("text");

        let rows = [];
        const t = text.trim();
        try {
          if (t.startsWith("[")) rows = JSON.parse(t);
          else if (t.startsWith("{")) {
            const one = JSON.parse(t);
            rows = Array.isArray(one) ? one : (one.features ? one.features.map(x => x.properties || x) : [one]);
          } else rows = parseCSV(text);
        } catch (e) {
          console.log("Skip file parse error:", fname, e);
          rows = [];
        }

        for (const r of rows) {
          const p = normalizePoint(r);
          if (p) points.push(p);
        }

        loaded++;
        const pct = 10 + Math.floor((loaded / files.length) * 70);
        setProgress(pct, `파일 로딩 ${loaded}/${files.length}... (누적 points=${points.length})`);
      }

      allPoints = points;
      dataLoaded = true;

      setProgress(85, "마커 생성 준비...");
      console.log("Data loaded", { files: files.length, points: allPoints.length });
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }

    function buildPopupHtml(p) {
      const cols = [
        ["loc", p?.loc],
        ["건물명", p?.["건물명"]],
        ["연면적(m²)", p?.["연면적(m²)"]],
        ["연면적(평)", p?.["연면적(평)"]],
        ["(추정) 지상 층당 면적", p?.["(추정) 지상 층당 면적"]],
        ["지상층수", p?.["지상층수"]],
        ["법정동", p?.["법정동"]],
        ["기타용도", p?.["기타용도"]],
        ["주용도", p?.["주용도"]],
        ["허가일", p?.["허가일"]],
        ["대장구분코드명", p?.["대장구분코드명"]],
        ["대장종류코드명", p?.["대장종류코드명"]],
        ["착공일", p?.["착공일"]],
        ["사용승인일", p?.["사용승인일"]],
      ];

      const sfUrl = String(p?.sfUrl ?? "").trim();
      const idStr = getIdForKey(p);

      const title = escapeHtml(String(p?.["건물명"] ?? "").trim() || "(이름 없음)");
      const linkHtml = sfUrl
        ? `<a href="${escapeHtml(sfUrl)}" target="_blank" rel="noopener noreferrer">Salesforce 열기</a>`
        : `<span class="muted">-</span>`;

      const rowsHtml = cols.map(([k,v]) => {
        const vv = (v === null || v === undefined || String(v).trim() === "") ? "-" : escapeHtml(String(v));
        return `<tr><td class="k">${escapeHtml(k)}</td><td class="v">${vv}</td></tr>`;
      }).join("");

      return `
        <div style="min-width:300px;">
          <div class="popupTitle">${title}</div>
          <div class="small muted" style="margin-bottom:8px;">Id: ${escapeHtml(idStr)}</div>
          <table class="popupTable">
            <tr><td class="k">sfUrl</td><td class="v">${linkHtml}</td></tr>
            ${rowsHtml}
          </table>
          <div class="small muted" style="margin-top:8px;">마커 클릭으로 선택/해제됩니다.</div>
        </div>
      `;
    }

    function buildAllMarkersOnce() {
      allMarkers = [];

      for (const p of allPoints) {
        const idKey = getIdForKey(p);
        if (!idKey) continue;

        const m = L.marker([p.lat, p.lng], { icon: iconFor(idKey) });

        m.on("click", (ev) => {
          if (ev?.originalEvent) L.DomEvent.stopPropagation(ev);

          if (assignedKeys.has(idKey)) {
            setProgress(0, "이미 캠페인에 포함된 건물입니다.");
            return;
          }

          if (selectedKeys.has(idKey)) {
            selectedKeys.delete(idKey);
            selectedPayloadByKey.delete(idKey);
          } else {
            selectedKeys.add(idKey);
            selectedPayloadByKey.set(idKey, buildSfPayloadFromPoint(p));
          }

          m.setIcon(iconFor(idKey));
          refreshUI(clusterLayer.getLayers().length);
        });

        m.bindPopup(buildPopupHtml(p));
        allMarkers.push({ key: idKey, lat: p.lat, lng: p.lng, marker: m, point: p });
      }
      console.log("Markers built", { markers: allMarkers.length });
    }

    function refreshMarkerIconsForAssignedSelected() {
      for (const it of allMarkers) it.marker.setIcon(iconFor(it.key));
    }

    function renderMarkersInView() {
      if (!dataLoaded || rendering) return;
      rendering = true;

      const b = map.getBounds();
      const inView = [];

      for (const it of allMarkers) {
        if (!b.contains([it.lat, it.lng])) continue;
        if (!passesFilters(it.point)) continue;

        inView.push(it);
        if (inView.length >= MAX_MARKERS_ON_SCREEN) break;
      }

      clusterLayer.clearLayers();
      clusterLayer.addLayers(inView.map(x => x.marker));

      refreshUI(inView.length);
      setProgress(100, `화면 렌더링 완료 (전체=${allMarkers.length}, 화면=${inView.length})`);
      setStatus("표시중", "ok");

      rendering = false;
    }

    let renderTimer = null;
    function scheduleRender() {
      if (renderTimer) clearTimeout(renderTimer);
      renderTimer = setTimeout(renderMarkersInView, 120);
    }

    map.on("moveend zoomend", scheduleRender);

    /**********************
     * VF 브릿지: assignedKeys 반영 (Id 기반)
     **********************/
    function applyAssignedKeys(list) {
      assignedKeys.clear();
      for (const k of (Array.isArray(list) ? list : [])) {
        const kk = String(k ?? "").trim();
        if (kk) assignedKeys.add(kk);
      }

      // 선택 중 assigned로 바뀐 것은 제거
      for (const k of Array.from(selectedKeys)) {
        if (assignedKeys.has(k)) {
          selectedKeys.delete(k);
          selectedPayloadByKey.delete(k);
        }
      }

      if (dataLoaded) {
        refreshMarkerIconsForAssignedSelected();
        scheduleRender();
      }
      refreshUI(clusterLayer.getLayers().length);
    }

    /**********************
     * 저장 요청/응답 (✅ ACK/RESULT 타임아웃 분리)
     **********************/
    const pending = new Map(); // requestId -> { ackTimer, resultTimer }

    function clearTimers(requestId) {
      const key = String(requestId);
      const it = pending.get(key);
      if (!it) return;
      if (it.ackTimer) clearTimeout(it.ackTimer);
      if (it.resultTimer) clearTimeout(it.resultTimer);
      pending.delete(key);
    }

    function armAckTimeout(requestId) {
      const key = String(requestId);
      clearTimers(key);
      const it = {};
      it.ackTimer = setTimeout(() => {
        clearTimers(key);
        setStatus("오류", "err");
        setError("Timeout: VF로부터 ACK를 받지 못했습니다.");
      }, ACK_TIMEOUT_MS);
      pending.set(key, it);
    }

    function armResultTimeout(requestId) {
      const key = String(requestId);
      const it = pending.get(key) || {};
      if (it.resultTimer) clearTimeout(it.resultTimer);
      it.resultTimer = setTimeout(() => {
        clearTimers(key);
        setStatus("오류", "err");
        setError("Timeout: VF로부터 RESULT를 받지 못했습니다. (캠페인 생성 모달 입력 시간이 길면 정상적으로 오래 걸릴 수 있으므로, VF/Map 설정을 확인하세요.)");
      }, RESULT_TIMEOUT_MS);
      pending.set(key, it);
    }

    function sendAddBuildings(buildings) {
      const requestId = String(Date.now());
      setError("");
      setStatus("전송중", "warn");
      setProgress(0, `Salesforce로 전송 중... (${buildings.length}개)`);

      if (!bridgeToken) {
        setStatus("오류", "err");
        setError("브릿지 토큰이 없습니다. (BL_INIT 수신 전)");
        console.log("Bridge token missing. Did VF send BL_INIT?");
        return;
      }

      // ✅ ACK만 짧게 기다린다
      armAckTimeout(requestId);

      postToParent({
        type: "BL_ADD_BUILDINGS",
        token: bridgeToken,
        requestId,
        campaignId: currentCampaignId,
        buildings
      });
    }

    /**********************
     * UI 버튼
     **********************/
    btnAddSelected.addEventListener("click", () => {
      if (selectedKeys.size === 0) return;
      if (!vfReady) {
        setStatus("대기", "warn");
        setError("VF 초기화(BL_INIT) 수신 전입니다. 잠시 후 다시 시도하세요.");
        return;
      }
      const buildings = Array.from(selectedPayloadByKey.values());
      sendAddBuildings(buildings);
    });

    btnClearSelected.addEventListener("click", () => {
      selectedKeys.clear();
      selectedPayloadByKey.clear();
      if (dataLoaded) refreshMarkerIconsForAssignedSelected();
      refreshUI(clusterLayer.getLayers().length);
      setProgress(0, "선택을 해제했습니다.");
    });

    /**********************
     * postMessage 수신
     **********************/
    window.addEventListener("message", (event) => {
      const data = event.data || {};
      if (!data.type) return;

      if (DEBUG_BRIDGE) console.log("Map recv", { origin: event.origin, data });

      if (data.type === "BL_INIT") {
        parentOrigin = event.origin || "*";
        bridgeToken = data.payload?.token || null;
        vfReady = true;

        currentCampaignId = data.payload?.campaignId ?? null;
        applyAssignedKeys(data.payload?.assignedKeys ?? []);

        setStatus("표시중", "ok");
        setProgress(0, "캠페인 컨텍스트 수신 완료");
        console.log("Bridge ready", { parentOrigin, bridgeToken, campaignId: currentCampaignId });
        return;
      }

      if (data.type === "BL_ADD_BUILDINGS_ACK") {
        const requestId = String(data.payload?.requestId || "");
        const it = pending.get(requestId);
        if (it?.ackTimer) clearTimeout(it.ackTimer);

        // ✅ 모달 입력/캠페인 생성 시간을 고려해 RESULT는 길게 기다린다
        armResultTimeout(requestId);

        setProgress(0, "VF에서 요청 수신(ACK). 저장 처리 대기/진행 중...");
        return;
      }

      if (data.type === "BL_ADD_BUILDINGS_RESULT") {
        const payload = data.payload || data;
        const requestId = String(payload.requestId || "");

        // ✅ ACK/RESULT 타이머 모두 정리
        clearTimers(requestId);

        if (payload.campaignId) currentCampaignId = payload.campaignId;
        if (Array.isArray(payload.assignedKeys)) applyAssignedKeys(payload.assignedKeys);

        if (payload.status === "ERROR") {
          setStatus("오류", "err");
          setError(payload.message || "저장 실패");
          setProgress(0, "저장 실패");
        } else {
          setStatus("완료", "ok");
          setError("");
          setProgress(0, payload.message || "저장 완료");

          selectedKeys.clear();
          selectedPayloadByKey.clear();
          if (dataLoaded) refreshMarkerIconsForAssignedSelected();
          refreshUI(clusterLayer.getLayers().length);
        }
        return;
      }

      if (data.type === "BL_ERROR") {
        setStatus("오류", "err");
        setError(data.payload?.message || data.message || "오류");
      }
    });

    /**********************
     * 시작
     **********************/
    (async function boot() {
      try {
        wireFilterEvents();

        refreshUI(0);
        setStatus("로딩중", "warn");

        // 1) VF에 READY
        postToParent({ type: "BL_READY", version: 4 });

        // 2) 데이터 ZIP 로딩 + 마커 생성
        await loadZipOnce();
        setProgress(90, "마커 생성 중...");
        buildAllMarkersOnce();

        // 3) 최초 렌더
        scheduleRender();
      } catch (e) {
        console.log(e);
        setStatus("오류", "err");
        setError(String(e?.message || e));
        setProgress(0, "데이터 로딩 실패");
      }
    })();
  </script>
</body>
</html>
