<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Seoul Building Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; }

    .panel{
      position:absolute; left:12px; top:12px; width:420px; max-width:calc(100vw - 24px);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:12px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      z-index:1000;
      backdrop-filter: blur(6px);
    }
    .title-row{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .title{ font-weight:800; font-size:16px; }
    .pill{
      padding:4px 8px; border-radius:999px; background:#f2f2f2; font-size:12px;
      border:1px solid rgba(0,0,0,.06);
      display:inline-block;
      margin-right:6px;
      margin-top:6px;
    }
    .pill.ok{ background:#e8f7ee; color:#0b6b2f; }
    .pill.err{ background:#fdecec; color:#9b1c1c; }
    .pill.warn{ background:#fff4e5; color:#8a4b00; }
    .muted{ color:#666; }
    .small{ font-size:12px; }
    .hr{ height:1px; background:#eee; margin:10px 0; }

    button{
      border:1px solid #d8d8d8; background:#fff; border-radius:10px;
      padding:8px 10px; cursor:pointer;
    }
    button.primary{ background:#2563eb; border-color:#2563eb; color:#fff; }
    button.danger{ background:#fee2e2; border-color:#fecaca; color:#991b1b; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    progress{ width:100%; height:10px; }
    .error{ color:#b91c1c; }

    details { border:1px solid rgba(0,0,0,.06); border-radius:12px; padding:8px 10px; background:#fff; }
    details summary { cursor:pointer; font-weight:700; font-size:12px; }
    .filters { margin-top:8px; display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .frow { display:flex; flex-direction:column; gap:4px; }
    .frow label { font-size:11px; color:#444; font-weight:700; }
    .frow input {
      border:1px solid #e5e5e5; border-radius:10px; padding:8px 10px; font-size:12px;
      outline:none;
    }
    .filters .span2 { grid-column: span 2; }

    .popupTable { width:100%; border-collapse:collapse; font-size:12px; }
    .popupTable td { border-top:1px solid #eee; padding:6px 4px; vertical-align:top; }
    .popupTable td.k { width:40%; color:#555; font-weight:700; }
    .popupTable td.v { width:60%; color:#111; }
    .popupTitle { font-weight:800; font-size:13px; margin-bottom:6px; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel">
    <div class="title-row">
      <div class="title">Seoul Building Map</div>
      <span class="pill" id="statusPill">준비</span>
    </div>

    <div class="muted small" style="margin-top:4px;">
      ZIP 1회 다운로드 → 화면 범위(geohash6 셀)만 렌더링 (bounds + 필터 동시 적용)
    </div>

    <div class="hr"></div>

    <div class="small">
      <span class="pill" id="campaignPill">Campaign: -</span>
      <span class="pill ok" id="selPill">선택: 0</span>
      <span class="pill" id="assignPill">할당됨: 0</span>
      <span class="pill" id="markerPill">화면 마커: 0</span>
    </div>

    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="primary" id="btnAddSelected">선택 추가</button>
      <button class="danger" id="btnClearSelected">선택 해제</button>
    </div>

    <!-- (중략: 필터 UI는 업로드본과 동일) -->

    <div style="margin-top:10px;">
      <progress id="progress" value="0" max="100"></progress>
      <div class="muted small" id="progressText">-</div>
      <div class="error small" id="errorText"></div>
    </div>
  </div>

  <script>
    /**********************
     * 설정
     **********************/
    const DEBUG_BRIDGE = true;

    // ✅ 데이터 ZIP
    const DATA_ZIP_URL = "https://cdn.jsdelivr.net/gh/AwtkMskang/sf-building-map-data@main/seoul_geohash6.zip";

    const MAX_MARKERS_ON_SCREEN = 20000;

    // ✅ 타임아웃 정책 (모달 입력시간 고려)
    const ACK_TIMEOUT_MS = 10 * 1000;          // 10초
    const RESULT_TIMEOUT_MS = 10 * 60 * 1000;  // 10분

    /**********************
     * DOM helpers
     **********************/
    const elStatus = document.getElementById("statusPill");
    const elCampaign = document.getElementById("campaignPill");
    const elSel = document.getElementById("selPill");
    const elAssign = document.getElementById("assignPill");
    const elMarker = document.getElementById("markerPill");
    const elProgress = document.getElementById("progress");
    const elProgressText = document.getElementById("progressText");
    const elError = document.getElementById("errorText");
    const btnAddSelected = document.getElementById("btnAddSelected");
    const btnClearSelected = document.getElementById("btnClearSelected");

    function setStatus(text, cls) {
      elStatus.textContent = text;
      elStatus.className = "pill " + (cls || "");
    }
    function setProgress(pct, text) {
      elProgress.value = Number(pct || 0);
      elProgressText.textContent = text || "-";
    }
    function setError(text) {
      elError.textContent = text || "";
    }

    /**********************
     * Bridge state
     **********************/
    let parentOrigin = "*";
    let bridgeToken = null;
    let vfReady = false;

    function postToParent(msg) {
      window.parent.postMessage(msg, parentOrigin || "*");
      if (DEBUG_BRIDGE) console.log("Map -> VF send", { targetOrigin: parentOrigin || "*", msg });
    }

    /**********************
     * (중략: 지도/데이터 로딩/필터/마커/선택 로직은 업로드본과 동일)
     **********************/

    /**********************
     * 저장 요청/응답 (✅ ACK/RESULT 타임아웃 분리)
     **********************/
    const pending = new Map(); // requestId -> { ackTimer, resultTimer }

    function clearTimers(requestId) {
      const key = String(requestId);
      const it = pending.get(key);
      if (!it) return;
      if (it.ackTimer) clearTimeout(it.ackTimer);
      if (it.resultTimer) clearTimeout(it.resultTimer);
      pending.delete(key);
    }

    function armAckTimeout(requestId) {
      const key = String(requestId);
      clearTimers(key);
      const it = {};
      it.ackTimer = setTimeout(() => {
        clearTimers(key);
        setStatus("오류", "err");
        setError("Timeout: VF로부터 ACK를 받지 못했습니다.");
      }, ACK_TIMEOUT_MS);
      pending.set(key, it);
    }

    function armResultTimeout(requestId) {
      const key = String(requestId);
      const it = pending.get(key) || {};
      if (it.resultTimer) clearTimeout(it.resultTimer);
      it.resultTimer = setTimeout(() => {
        clearTimers(key);
        setStatus("오류", "err");
        setError("Timeout: VF로부터 RESULT를 받지 못했습니다. (VF 모달 입력 시간이 길면 정상적으로 오래 걸릴 수 있습니다.)");
      }, RESULT_TIMEOUT_MS);
      pending.set(key, it);
    }

    function sendAddBuildings(buildings) {
      const requestId = String(Date.now());
      setError("");
      setStatus("전송중", "warn");
      setProgress(0, `Salesforce로 전송 중... (${buildings.length}개)`);

      if (!bridgeToken) {
        setStatus("오류", "err");
        setError("브릿지 토큰이 없습니다. (BL_INIT 수신 전)");
        return;
      }

      // ✅ ACK만 짧게 기다린다
      armAckTimeout(requestId);

      postToParent({
        type: "BL_ADD_BUILDINGS",
        token: bridgeToken,
        requestId,
        campaignId: null, // 캠페인 없으면 VF 모달로 처리
        buildings
      });
    }

    btnAddSelected.addEventListener("click", () => {
      if (!vfReady) {
        setStatus("대기", "warn");
        setError("VF 초기화(BL_INIT) 수신 전입니다. 잠시 후 다시 시도하세요.");
        return;
      }
      // 실제 buildings는 업로드본과 동일하게 selectedPayloadByKey 기반으로 구성
      // (여기서는 전체코드 길이상 생략했지만, 업로드본 그대로 두시면 됩니다.)
    });

    window.addEventListener("message", (event) => {
      const data = event.data || {};
      if (!data.type) return;
      if (DEBUG_BRIDGE) console.log("Map recv", { origin: event.origin, data });

      if (data.type === "BL_INIT") {
        parentOrigin = event.origin || "*";
        bridgeToken = data.payload?.token || null;
        vfReady = true;
        return;
      }

      if (data.type === "BL_ADD_BUILDINGS_ACK") {
        const requestId = String(data.payload?.requestId || "");
        const it = pending.get(requestId);
        if (it?.ackTimer) clearTimeout(it.ackTimer);
        armResultTimeout(requestId);
        setProgress(0, "VF에서 요청 수신(ACK). 저장 처리 대기/진행 중...");
        return;
      }

      if (data.type === "BL_ADD_BUILDINGS_RESULT") {
        const payload = data.payload || data;
        const requestId = String(payload.requestId || "");
        clearTimers(requestId);

        if (payload.status === "ERROR") {
          setStatus("오류", "err");
          setError(payload.message || "저장 실패");
        } else {
          setStatus("완료", "ok");
          setError("");
          setProgress(0, payload.message || "저장 완료");
        }
        return;
      }
    });

    (function boot() {
      postToParent({ type: "BL_READY", version: 4 });
    })();
  </script>
</body>
</html>
